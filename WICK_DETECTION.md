# 插针保险检测系统说明

## 什么是插针（Wick）？

插针是加密货币交易中的一种特殊价格波动现象：
- **价格瞬间剧烈下跌**（或上涨）
- **随后快速恢复**到接近原价
- 在K线图上表现为**长下影线**（或上影线）

## 检测逻辑

系统现在检测的是**下插针**：

### 检测条件
1. **插针深度** ≥ 阈值（默认10%）
   - 计算公式：`(close/open - low) / close/open * 100%`
   
2. **价格快速恢复**
   - K线实体小于开盘价的2%
   - 说明价格下探后迅速回升

### 示例
```
开盘价: $45,200
最低价: $40,000  ← 插针到这里
收盘价: $45,180  ← 快速恢复

插针深度: (45200 - 40000) / 45200 = 11.5%
实体大小: |45180 - 45200| / 45200 = 0.04% < 2% ✓
```

## 与传统暴跌保险的区别

| 特性 | 插针保险 | 暴跌保险 |
|------|---------|---------|
| 价格走势 | 瞬间下跌后恢复 | 持续下跌不恢复 |
| K线特征 | 长下影线，小实体 | 大阴线，持续红色 |
| 时间跨度 | 单根K线内 | 多根K线持续 |
| 保险场景 | 防止交易所爆仓、清算 | 防止长期持有损失 |

## 配置参数

在 `config.yaml` 中：

```yaml
detector:
  # 插针深度阈值（百分比）
  threshold_percent: 10.0
  # 窗口时间（插针检测不使用此参数）
  window_minutes: 5
```

## 检测结果

系统检测到的插针事件：

1. **2024-01-01 00:25:00** - 11.50% 插针
   - 从 $45,200 跌至 $40,000，恢复至 $45,180

2. **2024-01-01 00:50:00** - 13.00% 插针
   - 从 $45,400 跌至 $39,500，恢复至 $45,400

3. **2024-01-01 01:30:00** - 11.46% 插针
   - 从 $45,740 跌至 $40,500，恢复至 $45,740

## 可视化

运行 `python scripts/visualize_kline.py` 查看K线图：
- 绿色/红色蜡烛图显示价格走势
- **红色三角形**标记检测到的插针位置
- 长下影线清晰可见

## 保险触发

当检测到插针时：
1. 系统记录插针事件到数据库
2. 触发回调函数通知保险合约
3. 为持有有效保单的用户执行赔付

这种保险特别适合：
- **合约交易者** - 防止因瞬间插针被强制平仓
- **做市商** - 防止极端行情造成的滑点损失
- **高杠杆用户** - 保护免受闪崩清算
